<form [formGroup]="contractForm" *ngIf="this.contractForm" style="margin: 10px">
    <mat-grid-list cols="2" rowHeight="100px" gutterSize="10px">
        <mat-grid-tile colspan="2">
            <div fxLayout="column" fxLayoutAlign="center center">
                <h2 style="font-weight: bold">
                    {{ this.contractForm.value.contract_no }}
                </h2>
                <h4>
                    {{ this.contractForm.value.email }} /
                    {{ this.contractForm.value.phone }} /
                    {{ this.contractForm.value.telp }}
                </h4>
            </div>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Contract Category</mat-label>
                <mat-select formControlName="contract_category">
                    <mat-option
                        *ngFor="let o of contract_category"
                        value="{{ o.id }}"
                        >{{ o.title }}</mat-option
                    >
                </mat-select>
            </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile>
            <ng-select
                appendTo="body"
                [items]="datapenawaran"
                appearance="outline"
                bindLabel="no_penawaran"
                bindValue="id"
                formControlName="penawaran"
                placeholder="Select Penawaran"
                (change)="getValue($event, 'penawaran')"
                dropdownPosition="bottom"
                style="width: 100%"
                required
            >
                <ng-template ng-option-tmp let-item="item" let-index="index">
                    <b>{{ item.no_penawaran }}</b
                    >&nbsp;-&nbsp;{{ item.employee }}
                </ng-template>
                <ng-template ng-label-tmp let-item="item">
                    <b>{{ item.no_penawaran }}</b
                    >&nbsp;-&nbsp;{{ item.employee }}
                </ng-template>
            </ng-select>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>No PO</mat-label>
                <input formControlName="no_po" matInput #input />
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <div
                fxFlex
                FxLayout="row"
                fxLayoutAlign="space-between center"
                style="width: 100%"
            >
                <ng-select
                    appearance="outline"
                    appendTo="body"
                    [items]="customerhandle"
                    bindLabel="customer_name"
                    bindValue="idch"
                    placeholder="Select Customer"
                    (scrollToEnd)="onScrollToEnd('customer')"
                    formControlName="customerhandle"
                    (search)="onSearchi($event, 'customer')"
                    (clear)="reset()"
                    (change)="getValue($event, 'customer')"
                    dropdownPosition="bottom"
                    style="width: 100%; max-width: 450px"
                    required
                >
                    <ng-template
                        ng-option-tmp
                        let-item="item"
                        let-index="index"
                    >
                        <div
                            title="{{ item.customer_name }} - {{
                                item.name
                            }} ({{ item.email }})"
                        >
                            <b>{{ item.kode_customer }}</b
                            >&nbsp;-&nbsp;{{
                                item.customer_name
                            }}&nbsp;-&nbsp;{{ item.name }} ({{ item.email }})
                        </div>
                    </ng-template>
                    <ng-template ng-label-tmp let-item="item">
                        <div
                            title="{{ item.customer_name }} - {{
                                item.name
                            }} ({{ item.email }})"
                        >
                            <b>{{ item.kode_customer }}</b
                            >&nbsp;-&nbsp;{{
                                item.customer_name
                            }}&nbsp;-&nbsp;{{ item.name }} ({{ item.email }})
                        </div>
                    </ng-template>
                </ng-select>
                <div style="width: 5px"></div>
                <button
                    mat-mini-fab
                    type="button"
                    color="primary"
                    (click)="modalcustomerhandle()"
                >
                    <mat-icon>add</mat-icon>
                </button>
            </div>
        </mat-grid-tile>
        <!-- <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Customer Name</mat-label>
                <input formControlName="customer_name" matInput #input>
              </mat-form-field>
        </mat-grid-tile> -->
        <!-- <mat-grid-tile>
            <ng-select
                appearance="outline"
                appendTo="body"
                [items]="datacp"
                bindLabel="name"
                bindValue="id_cp"
                formControlName="contact_person"
                placeholder="Select Contact Person"
                (scrollToEnd)="onScrollToEnd('cp')"
                (search)="onSearchi($event, 'cp')"
                (clear)="reset()"
                (change)="getValue($event,'cp')"
                dropdownPosition="bottom"
                style="width: 100%;"
                required
            >
            </ng-select>
        </mat-grid-tile> -->
        <mat-grid-tile>
            <!-- <mat-form-field appearance="fill">
                <mat-label>Sample Source</mat-label>
                <mat-select>
                  <mat-option *ngFor="let o of typeContract" value="{{o.id}}">{{o.type}}</mat-option>
                </mat-select>
              </mat-form-field> -->

            <ng-select
                appearance="outline"
                appendTo="body"
                [items]="typeContract"
                bindLabel="type"
                formControlName="typeContract"
                bindValue="id"
                placeholder="Select Sample Source"
                dropdownPosition="bottom"
                style="width: 100%"
                required
            >
            </ng-select>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Address</mat-label>
                <mat-select formControlName="alamatcustomer">
                    <mat-option
                        *ngFor="let o of alamatcustomer"
                        value="{{ o.id_address }}"
                        >{{ o.address }}</mat-option
                    >
                </mat-select>
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Internal Desc</mat-label>
                <input matInput formControlName="desc_internal" #input />
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>External Desc</mat-label>
                <input matInput formControlName="desc" #input />
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <ng-select
                appearance="outline"
                appendTo="body"
                [items]="dataemployee"
                bindLabel="employee_name"
                bindValue="employee_id"
                placeholder="Select Sales / Marketing"
                formControlName="clienthandling"
                dropdownPosition="bottom"
                style="width: 100%"
                required
            >
                <ng-template ng-option-tmp let-item="item" let-index="index">
                    {{ item.employee_name }}
                </ng-template>
                <ng-template ng-label-tmp let-item="item">
                    {{ item.employee_name }}
                </ng-template>
            </ng-select>
        </mat-grid-tile>
        <mat-grid-tile colspan="2">
            <mat-card>
                <span style="font-weight: bold; color: maroon"
                    >* merubah email / phone / telp disini akan mengubah semua
                    kontrak yang memakai customer ini, jika tidak ingin merubah
                    semua harap menambahkan customer baru di atas *</span
                >
            </mat-card>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Phone</mat-label>
                <input matInput formControlName="phone" #input />
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Telp</mat-label>
                <input matInput formControlName="telp" #input />
            </mat-form-field>
        </mat-grid-tile>
        <mat-grid-tile>
            <mat-form-field appearance="fill">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" #input />
            </mat-form-field>
        </mat-grid-tile>
    </mat-grid-list>
    <table
        class="sample-table"
        *ngIf="
            this.contractForm.controls.sampleFormArray['controls'].length > 0
        "
    >
        <thead>
            <tr>
                <th *ngIf="this.copydata.length < 1">No</th>
                <th *ngIf="this.copydata.length > 0">
                    <button mat-flat-button color="warn" (click)="paste('all')">
                        Paste All
                    </button>
                </th>
                <th>No Sample</th>
                <th>Sample Name</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody formArrayName="sampleFormArray">
            <tr
                *ngFor="
                    let d of this.contractForm.controls.sampleFormArray[
                        'controls'
                    ];
                    let e = index
                "
                [formGroupName]="e"
            >
                <td width="10%">{{ e + 1 }}</td>
                <td>{{ d.value.no_sample }}</td>
                <td>
                    <mat-form-field appearance="fill">
                        <mat-label>Sample Name</mat-label>
                        <textarea
                            matInput
                            formControlName="sample_name"
                        ></textarea>
                    </mat-form-field>
                </td>
                <td style="text-align: right">
                    <span>{{ d.value.sample_price.toLocaleString() }}</span>
                </td>
                <td width="18%" style="text-align: center">
                    <button mat-icon-button matTooltip="Copy" (click)="copy(e)">
                        <mat-icon>file_copy</mat-icon>
                    </button>
                    <button
                        mat-icon-button
                        matTooltip="Paste"
                        (click)="paste(e)"
                    >
                        <mat-icon>forward</mat-icon>
                    </button>
                    <button mat-icon-button [matMenuTriggerFor]="menu2">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu2="matMenu">
                        <button mat-menu-item (click)="seedetail(e)">
                            <span>Details</span>
                        </button>
                        <button mat-menu-item (click)="deletesample(e)">
                            <span>Delete</span>
                        </button>
                    </mat-menu>
                </td>
            </tr>
        </tbody>
    </table>
    <div>
        <h2>Pricing</h2>
        <table class="sample-table">
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Total Biaya Pengujian
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        this.contractForm.controls.totalbiayapengujian.value
                            ? this.contractForm.controls.totalbiayapengujian.value.toLocaleString()
                            : 0
                    }}
                </td>
            </tr>
            <tr>
                <td style="text-align: left; font-weight: bold">
                    Discount Lepas
                </td>
                <td>
                    <input
                        type="text"
                        matInput
                        formControlName="disc_set"
                        style="width: 70px"
                        (keyup)="setDisc($event)"
                    />
                    <span>%</span>
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    <input
                        type="text"
                        matInput
                        currencyMask
                        formControlName="discount_lepas"
                        style="width: 200px"
                        (keyup)="setDiscountLepas($event)"
                        [options]="{
                            prefix: '',
                            thousands: '.',
                            precision: 0
                        }"
                    />
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Biaya Sampling
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        this.contractForm.controls.biaya_sampling.value
                            ? this.contractForm.controls.biaya_sampling.value.toLocaleString()
                            : 0
                    }}
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Biaya Akg
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        this.contractForm.controls.biaya_akg.value
                            ? this.contractForm.controls.biaya_akg.value.toLocaleString()
                            : 0
                    }}
                </td>
            </tr>

            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Subtotal
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        this.contractForm.controls.subtotal.value
                            ? this.contractForm.controls.subtotal.value.toLocaleString()
                            : 0
                    }}
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    PPN
                    {{
                        (
                            (this.contractForm.controls.ppn.value /
                                this.contractForm.controls.subtotal.value) *
                            100
                        ).toFixed()
                    }}
                    %
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        this.contractForm.controls.ppn.value
                            ? this.contractForm.controls.ppn.value.toLocaleString()
                            : 0
                    }}
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Total Cost
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        (
                            this.contractForm.controls.subtotal.value +
                            this.contractForm.controls.ppn.value
                        ).toLocaleString()
                    }}
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Downpayment
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    <input
                        type="text"
                        matInput
                        currencyMask
                        formControlName="downpayment"
                        style="width: 200px"
                        [options]="{
                            prefix: '',
                            thousands: '.',
                            precision: 0
                        }"
                    />
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: left; font-weight: bold">
                    Sisa Pembayaran
                </td>
                <td>Rp.</td>
                <td style="text-align: right">
                    {{
                        (
                            this.contractForm.controls.subtotal.value +
                            this.contractForm.controls.ppn.value -
                            this.contractForm.controls.downpayment.value
                        ).toLocaleString()
                    }}
                </td>
            </tr>
        </table>
    </div>
</form>
<div
    fxLayout="row"
    fxLayoutAlign="center center"
    style="width: 100%; margin-top: 10px"
>
    <button mat-raised-button color="primary" (click)="saveData()">Save</button>
    <div style="width: 10px"></div>
    <button mat-raised-button color="danger" (click)="cancel()">Cancel</button>
</div>
<ngx-spinner
    bdColor="rgba(255,255,255,1)"
    size="medium"
    color="#000"
    type="ball-clip-rotate-multiple"
    [fullScreen]="false"
></ngx-spinner>
